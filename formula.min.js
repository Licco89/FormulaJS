class Formula{constructor(t,e){this._container=t instanceof Element?t:document.querySelector(t),this._options={separators:[" ","Enter"],closers:"+-*/()%^",lang:{field:"Custom Field"},onFieldExpand:()=>({}),onUpdate:()=>{},...e},this._build(),this._listen()}_build(){this._container.classList.add("formula-js-container"),this._container.innerHTML=`\n\t\t\t<div class="formula-js-input">\n\t\t\t\t<div class="formula-js-caret"></div>\n\t\t\t</div>\n\t\t\t<div class="formula-js-buttons">\n\t\t\t\t${this._options.customFields?`<span class="formula-js-tag field-button">${this._options.lang.field}</span>`:""}\n\t\t\t\t${this._options.closers.split("").map(t=>`\n\t\t\t\t\t<span class="formula-js-tag single">${t}</span>\n\t\t\t\t`).join("")}\n\t\t\t</div>\n\t\t\t${this._options.customFields?'<div class="formula-js-fields formula-js-field-children"></div>':""}\n\t\t`,this._options.customFields&&this._buildFields(this._container.querySelector(".formula-js-fields"),this._options.customFields),this._input=this._container.firstElementChild,this._caret=this._input.firstElementChild}_buildFields(t,e,i="",s){const n=document.createElement("ul");t.appendChild(n),Object.entries(e).forEach(([t,{name:e,children:a,customData:l}])=>{const r=document.createElement("li");if(r.classList.add("formula-js-field"),r.setAttribute("data-field",i+t),r.setAttribute("data-name",s?s+" > "+e:e),r.innerText=e,this._listenToFieldClick(r),n.appendChild(r),a){const i=document.createElement("span");i.classList.add("children"),this._listenToFieldChevronClick(i,l),r.appendChild(i);const o=document.createElement("li");o.classList.add("formula-js-field-children"),!0!==a&&this._buildFields(o,a,t+".",s?s+" > "+e:e),n.appendChild(o)}})}_listenToFieldClick(t){t.addEventListener("click",()=>{const e=document.createElement("span");e.setAttribute("data-field",t.getAttribute("data-field")),e.innerText=t.getAttribute("data-name"),this._caret.insertAdjacentElement("beforebegin",e),Reflect.apply(this._options.onUpdate,this,[this.get()])})}_listenToFieldChevronClick(t,e){t.addEventListener("click",i=>{i.stopPropagation(),t.parentElement.classList.toggle("open"),t.parentElement.nextElementSibling.children.length||Reflect.apply(this._options.onFieldExpand,this,[t.parentElement,e]).then(e=>{this._buildFields(t.parentElement.nextElementSibling,e,t.parentElement.getAttribute("data-field")+".",t.parentElement.getAttribute("data-name"))}).catch(t=>{console.log(t)})})}_listen(){this._input.addEventListener("click",t=>{this._input.classList.add("active"),"SPAN"==t.target.nodeName&&t.target.insertAdjacentElement("afterend",this._caret)}),document.addEventListener("click",t=>{t.target.closest(".formula-js-input")||this._input.classList.remove("active")}),document.addEventListener("keydown",t=>{this._input.classList.contains("active")&&([37,39].includes(t.keyCode)?37==t.keyCode&&this._caret.previousElementSibling?this._caret.previousElementSibling.insertAdjacentElement("beforebegin",this._caret):39==t.keyCode&&this._caret.nextElementSibling&&this._caret.nextElementSibling.insertAdjacentElement("afterend",this._caret):this._options.separators.includes(t.key)?(t.preventDefault(),this._caret.textContent.length&&this._processUserInput()):this._handleKey(t))}),this._options.customFields&&this._container.querySelector(".field-button").addEventListener("click",t=>{t.target.classList.contains("active")?(t.target.classList.remove("active"),this._container.querySelector(".formula-js-fields").classList.remove("formula-js-field-open"),this._container.querySelectorAll(".formula-js-fields .open").forEach(t=>{t.classList.remove("open")})):(t.target.classList.add("active"),this._container.querySelector(".formula-js-fields").classList.add("formula-js-field-open"))}),this._container.querySelectorAll(".single").forEach(t=>{t.addEventListener("click",()=>{this.add(t.textContent)})})}_processUserInput(){const t=this._options.closers.split("").map(t=>t.replace(/[.*+?^${}()|[\]\\]/gu,"\\$&")).reduce((t,e)=>t.concat(["(?<="+e+")","(?="+e+")"]),[]),e=this._options.separators.map(t=>"Enter"==t?"\\n":t.replace(/[.*+?^${}()|[\]\\]/gu,"\\$&")).concat(t),i=new RegExp(e.join("|"),"u"),s=this._caret.textContent;this._caret.textContent="",s.split(i).forEach(t=>{const e=document.createElement("span");e.innerText=t,this._caret.insertAdjacentElement("beforebegin",e)}),Reflect.apply(this._options.onUpdate,this,[this.get()])}_handleKey(t){if(1==t.key.length)"v"==t.key&&t.ctrlKey?this._useClipboard():this._options.closers.includes(t.key)?(this._caret.textContent.length&&this._processUserInput(),this._caret.textContent=t.key,this._processUserInput()):this._caret.innerHTML+=t.key;else switch(t.keyCode){case 8:this._caret.textContent.length?this._caret.textContent=this._caret.textContent.slice(0,-1):this._caret.previousElementSibling&&this._caret.previousElementSibling.remove()}}_useClipboard(){navigator.clipboard.readText().then(t=>{this._caret.innerHTML+=t,this._processUserInput()}).catch(t=>{alert("Error while fetching clipboard: "+t)})}get(){return[...this._input.children].map(t=>t.getAttribute("data-field")||t.textContent).join(" ")}set(t){return this.clear().add(t)}add(t){return this._caret.textContent+=t,this._processUserInput(),this}clear(){return this._input.querySelectorAll("span").forEach(t=>{t.remove()}),this._caret.textContent="",this}destroy(){this._container.innerHTML="",this._container.classList.remove("formula-js-container"),this._options=null}static destroy(t){const e=document.querySelector(t);e&&e.classList.contains("formula-js-container")&&(e.innerHTML="",e.classList.remove("formula-js-container"))}}