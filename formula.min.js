class Formula{constructor(t,e){this._container=t instanceof Element?t:document.querySelector(t),this._options={separators:[" ","Enter"],closers:"+-*/()%^",...e},this._build(),this._listen()}_build(){this._container.classList.add("formula-js-container"),this._container.innerHTML='\n\t\t\t<div class="formula-js-input">\n\t\t\t\t<div class="formula-js-caret"></div>\n\t\t\t</div>\n\t\t',this._input=this._container.firstElementChild,this._caret=this._input.firstElementChild}_listen(){this._input.addEventListener("click",t=>{this._input.classList.add("active"),"SPAN"==t.target.nodeName&&t.target.insertAdjacentElement("afterend",this._caret)}),document.addEventListener("click",t=>{t.target.closest(".formula-js-input")||this._input.classList.remove("active")}),document.addEventListener("keydown",t=>{this._input.classList.contains("active")&&(console.log(t),[37,39].includes(t.keyCode)?37==t.keyCode&&this._caret.previousElementSibling?this._caret.previousElementSibling.insertAdjacentElement("beforebegin",this._caret):39==t.keyCode&&this._caret.nextElementSibling&&this._caret.nextElementSibling.insertAdjacentElement("afterend",this._caret):this._options.separators.includes(t.key)?this._caret.textContent.length&&this._processUserInput():this._handleKey(t))})}_processUserInput(){const t=this._options.closers.split("").map(t=>t.replace(/[.*+?^${}()|[\]\\]/gu,"\\$&")).reduce((t,e)=>t.concat(["(?<="+e+")","(?="+e+")"]),[]),e=this._options.separators.map(t=>"Enter"==t?"\\n":t.replace(/[.*+?^${}()|[\]\\]/gu,"\\$&")).concat(t),n=new RegExp(e.join("|"),"u"),s=this._caret.textContent;this._caret.textContent="",s.split(n).forEach(t=>{const e=document.createElement("span");e.innerText=t,this._caret.insertAdjacentElement("beforebegin",e)})}_handleKey(t){if(1==t.key.length)"v"==t.key&&t.ctrlKey?this._useClipboard():this._options.closers.includes(t.key)?(this._caret.textContent.length&&this._processUserInput(),this._caret.textContent=t.key,this._processUserInput()):this._caret.innerHTML+=t.key;else switch(t.keyCode){case 8:this._caret.textContent.length?this._caret.textContent=this._caret.textContent.slice(0,-1):this._caret.previousElementSibling&&this._caret.previousElementSibling.remove()}}_useClipboard(){navigator.clipboard.readText().then(t=>{this._caret.innerHTML+=t,this._processUserInput()}).catch(t=>{alert("Error while fetching clipboard: "+t)})}get(){return[...this._input.children].map(t=>t.textContent).join(" ")}set(t){return this.clear().add(t)}add(t){return this._caret.textContent=t,this._processUserInput(),this}clear(){return this._input.querySelectorAll("span").forEach(t=>{t.remove()}),this._caret.textContent="",this}destroy(){this._container.innerHTML="",this._container.classList.remove("formula-js-container"),this._options=null}static destroy(t){const e=document.querySelector(t);e&&e.classList.contains("formula-js-container")&&(e.innerHTML="",e.classList.remove("formula-js-container"))}}